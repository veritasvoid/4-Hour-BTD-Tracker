<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Tracker Hub</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-tertiary: #21262d;
            --bg-elevated: #282e36;
            --accent-primary: #58a6ff;
            --accent-green: #3fb950;
            --accent-red: #f85149;
            --accent-purple: #a371f7;
            --accent-cyan: #39c5cf;
            --text-primary: #e6edf3;
            --text-secondary: #8b949e;
            --text-tertiary: #6e7681;
            --border-default: #30363d;
            --border-muted: #21262d;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { font-size: 14px; }
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg-primary); color: var(--text-primary); min-height: 100vh; line-height: 1.5; -webkit-font-smoothing: antialiased; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-secondary); }
        ::-webkit-scrollbar-thumb { background: var(--border-default); border-radius: 4px; }
        .app-container { max-width: 1600px; margin: 0 auto; padding: 24px; }
        .nav-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 32px; padding-bottom: 20px; border-bottom: 1px solid var(--border-default); }
        .logo { display: flex; align-items: center; gap: 12px; }
        .logo-icon { width: 36px; height: 36px; background: linear-gradient(135deg, var(--accent-primary), var(--accent-purple)); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 18px; }
        .logo-text { font-size: 1.25rem; font-weight: 600; }
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.2s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .page-header { margin-bottom: 28px; }
        .page-title { font-size: 1.75rem; font-weight: 600; margin-bottom: 6px; }
        .page-subtitle { color: var(--text-secondary); font-size: 0.9375rem; }
        .input-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px; }
        .input-full { grid-column: 1 / -1; }
        .card { background: var(--bg-secondary); border-radius: 12px; border: 1px solid var(--border-default); padding: 20px; }
        .card-header { display: flex; align-items: center; gap: 10px; margin-bottom: 14px; }
        .card-icon { width: 32px; height: 32px; background: var(--bg-tertiary); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: var(--accent-primary); }
        .card-title { font-size: 0.8125rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-secondary); }
        .date-row-container { display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 16px; }
        .date-picker-row { display: flex; align-items: center; gap: 16px; }
        .date-picker-row label { font-size: 0.875rem; color: var(--text-secondary); font-weight: 500; }
        .page-nav-tabs { display: flex; gap: 4px; background: var(--bg-tertiary); padding: 4px; border-radius: 8px; }
        .page-nav-tab { padding: 8px 16px; border-radius: 6px; border: none; background: transparent; color: var(--text-secondary); font-family: 'Inter', sans-serif; font-size: 0.8125rem; font-weight: 500; cursor: pointer; transition: all 0.15s; }
        .page-nav-tab:hover { color: var(--text-primary); background: var(--bg-elevated); }
        .page-nav-tab.active { background: var(--accent-primary); color: #fff; }
        input[type="date"] { font-family: 'JetBrains Mono', monospace; padding: 10px 14px; background: var(--bg-tertiary); border: 1px solid var(--border-default); border-radius: 8px; color: var(--text-primary); font-size: 0.875rem; }
        input[type="date"]:focus { outline: none; border-color: var(--accent-primary); }
        textarea { width: 100%; height: 140px; background: var(--bg-tertiary); border: 1px solid var(--border-default); border-radius: 8px; padding: 14px; color: var(--text-primary); font-family: 'JetBrains Mono', monospace; font-size: 0.8125rem; resize: vertical; }
        textarea:focus { outline: none; border-color: var(--accent-primary); }
        textarea::placeholder { color: var(--text-tertiary); }
        .button-row { display: flex; gap: 10px; margin-bottom: 24px; flex-wrap: wrap; }
        .btn { font-family: 'Inter', sans-serif; font-weight: 500; padding: 10px 18px; border-radius: 8px; border: 1px solid transparent; cursor: pointer; font-size: 0.875rem; transition: all 0.15s; display: inline-flex; align-items: center; gap: 8px; }
        .btn svg { width: 16px; height: 16px; }
        .btn-primary { background: var(--accent-primary); color: #fff; }
        .btn-primary:hover { background: #4c9aed; transform: translateY(-1px); }
        .btn-secondary { background: var(--bg-tertiary); color: var(--text-primary); border-color: var(--border-default); }
        .btn-secondary:hover { background: var(--bg-elevated); }
        .btn-danger { background: transparent; color: var(--accent-red); border-color: var(--border-default); }
        .btn-danger:hover { background: rgba(248, 81, 73, 0.1); }
        .btn-success { background: transparent; color: var(--accent-green); border-color: var(--border-default); }
        .btn-success:hover { background: rgba(63, 185, 80, 0.1); }
        .btn-purple { background: var(--accent-purple); color: #fff; }
        .btn-purple:hover { background: #8957e5; transform: translateY(-1px); }
        .status-message { padding: 12px 16px; border-radius: 8px; margin-bottom: 20px; font-size: 0.875rem; display: none; }
        .status-success { background: rgba(63, 185, 80, 0.1); border: 1px solid rgba(63, 185, 80, 0.3); color: var(--accent-green); display: block; }
        .status-error { background: rgba(248, 81, 73, 0.1); border: 1px solid rgba(248, 81, 73, 0.3); color: var(--accent-red); display: block; }
        .status-info { background: rgba(88, 166, 255, 0.1); border: 1px solid rgba(88, 166, 255, 0.3); color: var(--accent-primary); display: block; }
        .results-card { background: var(--bg-secondary); border-radius: 12px; border: 1px solid var(--border-default); overflow: hidden; }
        .results-header { display: flex; justify-content: space-between; align-items: center; padding: 16px 20px; border-bottom: 1px solid var(--border-default); }
        .results-title { font-size: 0.9375rem; font-weight: 600; display: flex; align-items: center; gap: 10px; }
        .results-count { background: var(--bg-tertiary); padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; color: var(--text-secondary); }
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 0.8125rem; }
        thead { background: var(--bg-tertiary); position: sticky; top: 0; z-index: 10; }
        th { padding: 12px 16px; text-align: left; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; font-size: 0.6875rem; letter-spacing: 0.05em; border-bottom: 1px solid var(--border-default); white-space: nowrap; }
        td { padding: 14px 16px; border-bottom: 1px solid var(--border-muted); vertical-align: middle; }
        tbody tr { transition: filter 0.1s; }
        tbody tr:hover { filter: brightness(1.15); }
        .ticker-cell { font-family: 'JetBrains Mono', monospace; font-weight: 600; color: var(--accent-primary); cursor: pointer; }
        .ticker-cell:hover { color: var(--accent-cyan); }
        .ticker-cell::after { content: ' ‚Ä∫'; font-size: 0.75rem; opacity: 0.5; }
        .ticker-cell.expanded::after { content: ' ‚Äπ'; }
        .price-cell { font-family: 'JetBrains Mono', monospace; }
        .change-positive, .price-positive { color: var(--accent-green); font-weight: 600; }
        .change-negative, .price-negative { color: var(--accent-red); font-weight: 600; }
        .date-input { font-family: 'JetBrains Mono', monospace; padding: 6px 10px; background: var(--bg-tertiary); border: 1px solid var(--border-default); border-radius: 6px; color: var(--text-primary); font-size: 0.8125rem; }
        .price-input { font-family: 'JetBrains Mono', monospace; width: 85px; padding: 6px 10px; background: var(--bg-tertiary); border: 1px solid var(--border-default); border-radius: 6px; color: var(--text-primary); font-size: 0.8125rem; text-align: right; }
        .btn-remove { background: transparent; border: none; color: var(--text-tertiary); cursor: pointer; padding: 6px 8px; border-radius: 6px; opacity: 0.6; }
        .btn-remove:hover { background: rgba(248, 81, 73, 0.15); color: var(--accent-red); opacity: 1; }
        .empty-state { text-align: center; padding: 60px 20px; color: var(--text-tertiary); }
        .empty-state svg { width: 48px; height: 48px; margin-bottom: 16px; opacity: 0.4; }
        .empty-state p { max-width: 320px; margin: 0 auto; }
        .loading { display: inline-block; width: 14px; height: 14px; border: 2px solid var(--border-default); border-top-color: var(--accent-primary); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .company-info-row td { padding: 0; }
        .company-info-content { padding: 20px 24px; display: grid; grid-template-columns: 1fr 1fr; gap: 16px; background: var(--bg-tertiary); }
        .company-info-section { background: var(--bg-secondary); border-radius: 10px; padding: 16px; border: 1px solid var(--border-default); }
        .company-info-section h4 { font-size: 0.6875rem; text-transform: uppercase; margin-bottom: 10px; font-weight: 600; }
        .company-info-section p { color: var(--text-secondary); font-size: 0.875rem; line-height: 1.6; }
        .company-info-section a { color: var(--accent-primary); text-decoration: none; }
        .company-info-loading { text-align: center; padding: 30px; color: var(--text-secondary); grid-column: 1 / -1; }
        .info-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .info-item { background: var(--bg-tertiary); padding: 10px 12px; border-radius: 6px; }
        .info-item label { font-size: 0.625rem; text-transform: uppercase; color: var(--text-tertiary); display: block; margin-bottom: 4px; }
        .info-item span { font-family: 'JetBrains Mono', monospace; font-size: 0.8125rem; }
        .news-cell { max-width: 280px; font-size: 0.8125rem; color: var(--text-secondary); }
        .insider-badge { display: inline-block; padding: 3px 8px; border-radius: 4px; font-size: 0.6875rem; font-weight: 600; text-transform: uppercase; background: rgba(163, 113, 247, 0.15); color: var(--accent-purple); }
        .amount-cell { font-family: 'JetBrains Mono', monospace; color: var(--accent-green); font-weight: 500; }
        .snapshot-section h4 { color: var(--accent-primary); }
        .bottomline-section h4 { color: var(--accent-purple); }
        .bottomline-header { display: flex; gap: 16px; align-items: flex-start; margin-bottom: 12px; flex-wrap: wrap; }
        .buy-score { min-width: 120px; padding: 10px 14px; border-radius: 10px; border: 1px solid var(--border-default); background: var(--bg-tertiary); text-align: center; font-family: 'Inter', sans-serif; }
        .buy-score-label { font-size: 0.6875rem; text-transform: uppercase; letter-spacing: 0.06em; color: var(--text-tertiary); margin-bottom: 4px; }
        .buy-score-verdict { font-size: 1.1rem; font-weight: 700; letter-spacing: 0.04em; margin-bottom: 2px; }
        .buy-score-percent { font-family: 'JetBrains Mono', monospace; font-size: 0.9rem; }
        .verdict-yes { border-color: rgba(63, 185, 80, 0.4); background: rgba(63, 185, 80, 0.08); }
        .verdict-yes .buy-score-verdict, .verdict-yes .buy-score-percent { color: var(--accent-green); }
        .verdict-no { border-color: rgba(248, 81, 73, 0.4); background: rgba(248, 81, 73, 0.08); }
        .verdict-no .buy-score-verdict, .verdict-no .buy-score-percent { color: var(--accent-red); }
        .verdict-maybe { border-color: rgba(238, 171, 9, 0.4); background: rgba(238, 171, 9, 0.08); }
        .verdict-maybe .buy-score-verdict, .verdict-maybe .buy-score-percent { color: #f2b236; }
        .bottomline-text { flex: 1; font-size: 0.875rem; color: var(--text-secondary); line-height: 1.6; }
        .fundamentals-grid { margin-top: 10px; }
        @media (max-width: 768px) { .app-container { padding: 16px; } .input-grid { grid-template-columns: 1fr; } .button-row { flex-direction: column; } .btn { width: 100%; justify-content: center; } .company-info-content { grid-template-columns: 1fr; } .date-row-container { flex-direction: column; align-items: flex-start; } .bottomline-header { flex-direction: column; align-items: stretch; } .buy-score { align-self: stretch; } }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="nav-header">
            <div class="logo"><div class="logo-icon">üìà</div><span class="logo-text">Stock Tracker Hub</span></div>
        </header>
        <div id="page-comparison" class="page active">
            <div class="page-header"><h1 class="page-title">Stock Tracker Hub</h1><p class="page-subtitle">Parse, compare, and track stock performance with real-time price updates</p></div>
            <div class="input-grid">
                <div class="card input-full">
                    <div class="date-row-container">
                        <div class="date-picker-row"><label for="dataDate">Data Date</label><input type="date" id="dataDate"></div>
                        <div class="page-nav-tabs">
                            <button class="page-nav-tab active" onclick="showPage('comparison')" id="nav1-comparison">Stock Comparison</button>
                            <button class="page-nav-tab" onclick="showPage('insider')" id="nav1-insider">Insider Tracking</button>
                        </div>
                    </div>
                </div>
                <div class="card"><div class="card-header"><div class="card-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/></svg></div><span class="card-title">Data Set 1</span></div><textarea id="dataset1" placeholder="Paste your first data set here..."></textarea></div>
                <div class="card"><div class="card-header"><div class="card-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/></svg></div><span class="card-title">Data Set 2</span></div><textarea id="dataset2" placeholder="Paste your second data set here..."></textarea></div>
            </div>
            <div class="button-row">
                <button class="btn btn-primary" onclick="compareAndParse()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>Compare & Parse</button>
                <button class="btn btn-secondary" onclick="refreshPrices()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>Refresh Prices</button>
                <button class="btn btn-danger" onclick="clearAll()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>Clear All</button>
                <button class="btn btn-success" onclick="exportToCSV()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>Export CSV</button>
            </div>
            <div id="statusMessage" class="status-message"></div>
            <div class="results-card">
                <div class="results-header"><h2 class="results-title">Results <span class="results-count" id="rowCount">0 rows</span></h2></div>
                <div class="table-container"><table><thead><tr><th>#</th><th>Date</th><th>Ticker</th><th>Company Name</th><th>Price</th><th>Current Price</th><th>% Change</th><th></th></tr></thead><tbody id="resultsBody"></tbody></table></div>
                <div id="emptyState" class="empty-state"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M9 17H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><path d="M15 3h4a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-4"/></svg><p>No data yet. Paste your data sets above and click "Compare & Parse".</p></div>
            </div>
        </div>
        <div id="page-insider" class="page">
            <div class="page-header"><h1 class="page-title">Stock Tracker Hub</h1><p class="page-subtitle">Track insider buy signals from CEO Watcher alerts automatically</p></div>
            <div class="input-grid">
                <div class="card input-full">
                    <div class="date-row-container">
                        <div class="date-picker-row"><label>Insider Tracking</label></div>
                        <div class="page-nav-tabs">
                            <button class="page-nav-tab" onclick="showPage('comparison')" id="nav2-comparison">Stock Comparison</button>
                            <button class="page-nav-tab active" onclick="showPage('insider')" id="nav2-insider">Insider Tracking</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="button-row">
                <button class="btn btn-purple" onclick="triggerInsiderGmailScan()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>Scan Gmail Now</button>
                <button class="btn btn-secondary" onclick="refreshInsiderPrices()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>Refresh Prices</button>
                <button class="btn btn-success" onclick="exportInsiderCSV()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>Export CSV</button>
            </div>
            <div id="insiderStatusMessage" class="status-message"></div>
            <div class="results-card">
                <div class="results-header"><h2 class="results-title">Insider Buy Alerts <span class="results-count" id="insiderRowCount">0 rows</span></h2></div>
                <div class="table-container"><table><thead><tr><th>#</th><th>Date</th><th>Ticker</th><th>Company</th><th>News</th><th>Insider</th><th>Amount</th><th>Alert Price</th><th>Current Price</th><th>% Change</th></tr></thead><tbody id="insiderResultsBody"></tbody></table></div>
                <div id="insiderEmptyState" class="empty-state"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg><p>No insider trades yet. Click "Scan Gmail Now" or wait for automatic daily import at 8am.</p></div>
            </div>
        </div>
    </div>
    <script>
        const GOOGLE_SHEETS_ID = '19WB8SI3DBXKIeqyfGn2W2ihRLdI6_F5C0dhEucYSoNs';
        const GOOGLE_API_KEY = 'AIzaSyDzZYtdzU74EaBpYjo-e3kDdMaHmnN-2Uw';
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyUWr5tAmIpil3jb8n44nnbdlNoeLk0qMuqZrQO8uxJa2ANdOloe7aaBuVKz7QkJa7p/exec';
        const ALPACA_API_KEY = 'PKBSZSHCEISQ3JMHIO4ZUBIQHZ';
        const ALPACA_SECRET_KEY = '56SAQ2bypqzr5YYdHxuyri5RVNWCfmSpEm9Jyv1aEX6o';
        const ALPACA_DATA_URL = 'https://data.alpaca.markets/v2';
        const ALPACA_TRADING_URL = 'https://paper-api.alpaca.markets/v2';
        const FINNHUB_API_KEY = 'd4k7dohr01qvpdoie0rgd4k7dohr01qvpdoie0s0';
        const XAI_API_KEY = 'xai-1z6uoZKQmfbXFBDdG2oVz447akjeQmmYdHfXcuKCieAkLauIuTiCsEMtlzGj5DEmuLAppSi0K9csZGlY';

        let grokAnalysisByTicker = {};
        const dateColors = ['rgba(56, 139, 253, 0.20)', 'rgba(46, 160, 67, 0.20)', 'rgba(137, 87, 229, 0.20)', 'rgba(219, 171, 9, 0.20)', 'rgba(238, 87, 55, 0.20)', 'rgba(13, 170, 182, 0.20)', 'rgba(191, 74, 142, 0.20)', 'rgba(96, 125, 217, 0.20)', 'rgba(204, 120, 50, 0.20)', 'rgba(121, 184, 202, 0.20)', 'rgba(163, 113, 247, 0.20)', 'rgba(255, 123, 114, 0.20)', 'rgba(125, 201, 145, 0.20)', 'rgba(255, 166, 87, 0.20)', 'rgba(149, 157, 239, 0.20)', 'rgba(238, 145, 179, 0.20)', 'rgba(98, 205, 192, 0.20)', 'rgba(185, 152, 104, 0.20)', 'rgba(87, 171, 90, 0.20)', 'rgba(175, 140, 200, 0.20)'];
        let dateColorMap = {}, colorIndex = 0;
        function getDateColor(date) { if (!dateColorMap[date]) { dateColorMap[date] = dateColors[colorIndex++ % dateColors.length]; } return dateColorMap[date]; }

        function showPage(page) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('page-' + page).classList.add('active');
            document.querySelectorAll('.page-nav-tab').forEach(t => t.classList.remove('active'));
            if (page === 'comparison') { document.getElementById('nav1-comparison').classList.add('active'); document.getElementById('nav2-comparison').classList.add('active'); }
            else { document.getElementById('nav1-insider').classList.add('active'); document.getElementById('nav2-insider').classList.add('active'); }
            if (page === 'insider') loadInsiderData();
        }

        let parsedData = [], rowIdCounter = 0, insiderData = [];
        document.addEventListener('DOMContentLoaded', async () => { document.getElementById('dataDate').value = new Date().toISOString().split('T')[0]; await loadFromGoogleSheets(); await loadGrokAnalysis(); });

        function showStatus(msg, type) { const el = document.getElementById('statusMessage'); el.textContent = msg; el.className = 'status-message status-' + type; setTimeout(() => el.className = 'status-message', 5000); }
        function showInsiderStatus(msg, type) { const el = document.getElementById('insiderStatusMessage'); el.textContent = msg; el.className = 'status-message status-' + type; setTimeout(() => el.className = 'status-message', 5000); }

        async function loadGrokAnalysis() {
            try {
                const res = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${GOOGLE_SHEETS_ID}/values/GrokAnalysis?key=${GOOGLE_API_KEY}`);
                if (!res.ok) return;
                const data = await res.json();
                const rows = data.values || [];
                const dataRows = rows.length > 0 && rows[0][0] === 'ticker' ? rows.slice(1) : rows;
                dataRows.forEach(row => {
                    const [ticker, grokSector, grokWhatItDoes, grokBottomLine, grokBuyTheDip, lastUpdated] = row;
                    if (!ticker) return;
                    grokAnalysisByTicker[ticker.toUpperCase()] = { grokSector: grokSector || '', grokWhatItDoes: grokWhatItDoes || '', grokBottomLine: grokBottomLine || '', grokBuyTheDip: grokBuyTheDip || '', lastUpdated: lastUpdated || '' };
                });
            } catch (e) { console.log('GrokAnalysis sheet not found'); }
        }

        async function getOrFetchGrokAnalysis(ticker) {
            ticker = (ticker || '').trim().toUpperCase();
            if (!ticker) return null;
            if (grokAnalysisByTicker[ticker]) return grokAnalysisByTicker[ticker];

            try {
                const systemPrompt = `You are a stock analyst bot. For any ticker input (e.g., "AAPL"), respond ONLY in this exact format, using real-time data from tools/searches. Keep it trimmed and data-backed. No extras, no chit-chat.

**TICKER (Full Company Name)**  
Sector: [1-2 words] / [Subsector]  
What it does: [1-2 sentences max, factual overview].

**Bottom Line:** [Yes/No, buy the dip ‚Äì 1-2 sentences: Key dip reason, upside % to target, main risk with downside %. End with hold horizon if relevant.]  
**Buy the dip: Yes/No ‚Äî X% certainty**

If data insufficient, say "Wait ‚Äî X% certainty" and explain briefly in Bottom Line. Always truthful, cite implicitly via facts.`;

                const res = await fetch('https://api.x.ai/v1/chat/completions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${XAI_API_KEY}` },
                    body: JSON.stringify({ model: 'grok-3-latest', messages: [{ role: 'system', content: systemPrompt }, { role: 'user', content: ticker }], temperature: 0.7 })
                });

                if (!res.ok) return null;
                const data = await res.json();
                const content = data.choices?.[0]?.message?.content || '';
                const record = parseGrokResponse(content);
                record.lastUpdated = new Date().toISOString().split('T')[0];
                grokAnalysisByTicker[ticker] = record;

                try { await fetch(APPS_SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'saveGrokAnalysis', ticker, ...record }) }); } catch (e) {}
                return record;
            } catch (e) { return null; }
        }

        function parseGrokResponse(content) {
            let grokSector = '', grokWhatItDoes = '', grokBottomLine = '', grokBuyTheDip = '';
            content = content.replace(/\*\*/g, '');
            const sectorMatch = content.match(/Sector:\s*(.+?)(?:\n|What it does)/i);
            if (sectorMatch) grokSector = sectorMatch[1].trim();
            const whatMatch = content.match(/What it does:\s*(.+?)(?:\n\n|Bottom Line)/is);
            if (whatMatch) grokWhatItDoes = whatMatch[1].trim().replace(/\n/g, ' ');
            const bottomMatch = content.match(/Bottom Line:\s*(.+?)(?:\nBuy the dip|$)/is);
            if (bottomMatch) grokBottomLine = bottomMatch[1].trim().replace(/\n/g, ' ');
            const buyMatch = content.match(/Buy the dip:\s*(.+?)(?:\n|$)/i);
            if (buyMatch) grokBuyTheDip = buyMatch[1].trim();
            return { grokSector, grokWhatItDoes, grokBottomLine, grokBuyTheDip };
        }

        async function loadFromGoogleSheets() {
            try { showStatus('Loading...', 'info');
                const res = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${GOOGLE_SHEETS_ID}/values/Sheet1?key=${GOOGLE_API_KEY}`);
                if (res.ok) { const data = await res.json(); const rows = data.values || []; const dataRows = rows.length > 0 && rows[0][0] === 'id' ? rows.slice(1) : rows;
                    if (dataRows.length > 0) { parsedData = dataRows.map(row => ({ id: parseInt(row[0]) || ++rowIdCounter, date: row[1] || '', ticker: row[2] || '', companyName: row[3] || '', price: parseFloat(row[4]) || 0, currentPrice: row[5] ? (row[5] === 'manual' ? 'manual' : parseFloat(row[5])) : null, expanded: false, companyInfo: null })); rowIdCounter = Math.max(...parsedData.map(d => d.id), 0); renderTable(); showStatus(`Loaded ${parsedData.length} rows`, 'success'); fetchCurrentPrices(parsedData.filter(item => item.currentPrice === null)); }
                    else { renderTable(); showStatus('Ready', 'info'); } }
            } catch (e) { showStatus('Connection error', 'error'); }
        }

        async function saveToGoogleSheets() { try { const header = ['id', 'date', 'ticker', 'companyName', 'price', 'currentPrice']; const rows = parsedData.map(item => [item.id, item.date, item.ticker, item.companyName, item.price, item.currentPrice === null ? '' : item.currentPrice]); await fetch(APPS_SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ data: [header, ...rows] }) }); } catch (e) {} }
        let saveTimeout = null;
        function autoSave() { if (saveTimeout) clearTimeout(saveTimeout); saveTimeout = setTimeout(saveToGoogleSheets, 1000); }

        async function fetchCurrentPrices(items) { if (!items || items.length === 0) return; for (const item of items) { try { const res = await fetch(`${ALPACA_DATA_URL}/stocks/${item.ticker}/trades/latest`, { headers: { 'APCA-API-KEY-ID': ALPACA_API_KEY, 'APCA-API-SECRET-KEY': ALPACA_SECRET_KEY } }); if (res.ok) { const data = await res.json(); item.currentPrice = data.trade?.p || 'manual'; } else { item.currentPrice = 'manual'; } } catch (e) { item.currentPrice = 'manual'; } renderTable(); await new Promise(r => setTimeout(r, 150)); } autoSave(); }

        function parseDataSet(rawData) { const results = []; let data = rawData.trim(); if (!data) return results; const marketCapPattern = /(\d{1,3}(?:,\d{3})*)\s*M(?=\s*[A-Z]|$)/g; let match; const positions = []; while ((match = marketCapPattern.exec(data)) !== null) { positions.push({ end: match.index + match[0].length }); } let startPos = 0; const segments = []; for (const pos of positions) { segments.push(data.substring(startPos, pos.end).trim()); startPos = pos.end; } if (segments.length === 0) segments.push(data); if (startPos < data.length) { const remaining = data.substring(startPos).trim(); if (remaining && remaining !== 'M') segments.push(remaining); } for (const segment of segments) { const parsed = parseRecord(segment); if (parsed) results.push(parsed); } return results; }
        function parseRecord(record) { record = record.trim().replace(/\s*M\s*$/, ''); const tokens = record.split(/\s+/); if (tokens.length < 4) return null; let ticker = tokens[0], priceIndex = -1; for (let i = 1; i < tokens.length; i++) { if (/^\d*\.?\d+$/.test(tokens[i]) && tokens[i].includes('.')) { priceIndex = i; break; } } if (priceIndex === -1) return null; return { ticker, companyName: tokens.slice(1, priceIndex).join(' '), price: parseFloat(tokens[priceIndex]) }; }

        function compareAndParse() { const dataset1 = document.getElementById('dataset1').value; const dataset2 = document.getElementById('dataset2').value; const selectedDate = document.getElementById('dataDate').value; if (!dataset1 || !dataset2) { showStatus('Paste data in both sets', 'error'); return; } if (!selectedDate) { showStatus('Select a date', 'error'); return; } const set1 = parseDataSet(dataset1), set2 = parseDataSet(dataset2); if (set1.length === 0 || set2.length === 0) { showStatus('Could not parse data', 'error'); return; } const set2Tickers = new Set(); for (const item of set2) { let ticker = item.ticker; if (ticker.startsWith('M') && ticker.length > 1) set2Tickers.add(ticker.substring(1)); set2Tickers.add(ticker); } const commonItems = [], addedTickers = new Set(); for (const item of set1) { let cleanTicker = item.ticker; if (cleanTicker.startsWith('M') && cleanTicker.length > 1) { const withoutM = cleanTicker.substring(1); if (set2Tickers.has(withoutM)) cleanTicker = withoutM; } if ((set2Tickers.has(cleanTicker) || set2Tickers.has('M' + cleanTicker)) && !addedTickers.has(cleanTicker)) { addedTickers.add(cleanTicker); commonItems.push({ ticker: cleanTicker, companyName: item.companyName, price: item.price, date: selectedDate, id: ++rowIdCounter, currentPrice: null }); } } if (commonItems.length === 0) { showStatus('No common tickers', 'error'); return; } parsedData = parsedData.concat(commonItems); document.getElementById('dataset1').value = ''; document.getElementById('dataset2').value = ''; showStatus(`Found ${commonItems.length} ticker(s)`, 'success'); renderTable(); fetchCurrentPrices(commonItems); autoSave(); }

        function calculateChange(original, current) { if (current === null || current === 'manual' || isNaN(current)) return null; return ((current - original) / original) * 100; }

        function renderTable() {
            const tbody = document.getElementById('resultsBody'); const emptyState = document.getElementById('emptyState'); document.getElementById('rowCount').textContent = `${parsedData.length} rows`;
            if (parsedData.length === 0) { tbody.innerHTML = ''; emptyState.style.display = 'block'; return; } emptyState.style.display = 'none';
            tbody.innerHTML = parsedData.map((item, index) => {
                const change = calculateChange(item.price, item.currentPrice); const changeClass = change !== null ? (change >= 0 ? 'change-positive' : 'change-negative') : ''; const changeText = change !== null ? `${change >= 0 ? '+' : ''}${change.toFixed(2)}%` : '‚Äî';
                let currentPriceText, currentPriceClass = '';
                if (item.currentPrice === null) { currentPriceText = '<span class="loading"></span>'; }
                else if (item.currentPrice === 'manual') { currentPriceText = `<input type="number" step="0.01" class="price-input" placeholder="Enter" onchange="updateCurrentPrice(${item.id}, this.value)">`; }
                else { currentPriceClass = item.currentPrice >= item.price ? 'price-positive' : 'price-negative'; currentPriceText = `$${parseFloat(item.currentPrice).toFixed(2)}`; }
                const rowColor = getDateColor(item.date); const isExpanded = item.expanded || false;
                let html = `<tr style="background-color: ${rowColor};"><td>${index + 1}</td><td><input type="date" class="date-input" value="${item.date}" onchange="updateDate(${item.id}, this.value)"></td><td class="ticker-cell ${isExpanded ? 'expanded' : ''}" onclick="toggleCompanyInfo(${item.id})">${item.ticker}</td><td>${item.companyName}</td><td class="price-cell">$${item.price.toFixed(2)}</td><td class="price-cell ${currentPriceClass}">${currentPriceText}</td><td class="${changeClass}">${changeText}</td><td><button class="btn-remove" onclick="removeRow(${item.id})">‚úï</button></td></tr>`;
                if (isExpanded) { html += `<tr class="company-info-row" style="background-color: ${rowColor};"><td colspan="8"><div class="company-info-content">${item.companyInfo ? renderCompanyInfo(item) : '<div class="company-info-loading"><span class="loading"></span> Loading AI analysis...</div>'}</div></td></tr>`; }
                return html;
            }).join('');
        }

        function renderCompanyInfo(item) {
            const info = item.companyInfo;
            if (!info || info.error) return '<p style="color: var(--accent-red);">Unable to load info</p>';
            const snapshotText = info.grokWhatItDoes || info.description || 'No description available.';
            const bottomlineText = info.grokBottomLine || 'No AI bottom line available yet.';
            const verdictRaw = info.grokBuyTheDip || '';
            let verdict = '', percent = '';
            if (verdictRaw) { const match = verdictRaw.match(/(Yes|No|Maybe|Wait)[^\d]*([\d]{1,3})%/i); if (match) { verdict = match[1].toUpperCase(); percent = match[2] + '%'; } }
            let verdictClass = ''; if (verdict === 'YES') verdictClass = 'verdict-yes'; else if (verdict === 'NO') verdictClass = 'verdict-no'; else if (verdict) verdictClass = 'verdict-maybe';
            const scoreboardHtml = verdict ? `<div class="buy-score ${verdictClass}"><div class="buy-score-label">Buy the dip</div><div class="buy-score-verdict">${verdict}</div><div class="buy-score-percent">${percent}</div></div>` : '';
            return `<div class="company-info-section snapshot-section"><h4>üìã Snapshot</h4><p>${snapshotText}</p>${info.grokSector ? `<p style="margin-top:8px;color:var(--text-tertiary);font-size:0.8rem;">Sector: ${info.grokSector}</p>` : ''}${info.weburl ? `<p style="margin-top:10px;"><a href="${info.weburl}" target="_blank">üåê Website</a></p>` : ''}</div><div class="company-info-section bottomline-section"><h4>üìä Bottom Line</h4><div class="bottomline-header">${scoreboardHtml}<div class="bottomline-text">${bottomlineText}</div></div><div class="info-grid fundamentals-grid"><div class="info-item"><label>Exchange</label><span>${info.exchange || 'N/A'}</span></div><div class="info-item"><label>Industry</label><span>${info.industry || 'N/A'}</span></div><div class="info-item"><label>Tradable</label><span style="color:${info.tradable ? 'var(--accent-green)' : 'var(--accent-red)'}">${info.tradable ? 'Yes' : 'No'}</span></div><div class="info-item"><label>Shortable</label><span style="color:${info.shortable ? 'var(--accent-green)' : 'var(--accent-red)'}">${info.shortable ? 'Yes' : 'No'}</span></div></div></div>`;
        }

        async function toggleCompanyInfo(id) { const item = parsedData.find(d => d.id === id); if (!item) return; item.expanded = !item.expanded; renderTable(); if (item.expanded && !item.companyInfo) await fetchCompanyInfo(item); }

        async function fetchCompanyInfo(item) {
            let info = {};
            try { const res = await fetch(`${ALPACA_TRADING_URL}/assets/${item.ticker}`, { headers: { 'APCA-API-KEY-ID': ALPACA_API_KEY, 'APCA-API-SECRET-KEY': ALPACA_SECRET_KEY } }); if (res.ok) { const asset = await res.json(); info = { exchange: asset.exchange, tradable: asset.tradable, shortable: asset.shortable }; } } catch (e) {}
            try { const res = await fetch(`https://finnhub.io/api/v1/stock/profile2?symbol=${item.ticker}&token=${FINNHUB_API_KEY}`); if (res.ok) { const profile = await res.json(); if (profile.finnhubIndustry) { info.industry = profile.finnhubIndustry; info.weburl = profile.weburl; info.description = `${profile.name || item.companyName} operates in ${profile.finnhubIndustry}.`; } } } catch (e) {}
            try { const grok = await getOrFetchGrokAnalysis(item.ticker); if (grok) { info.grokSector = grok.grokSector; info.grokWhatItDoes = grok.grokWhatItDoes; info.grokBottomLine = grok.grokBottomLine; info.grokBuyTheDip = grok.grokBuyTheDip; } } catch (e) {}
            item.companyInfo = Object.keys(info).length ? info : { error: true }; renderTable();
        }

        function updateDate(id, newDate) { const item = parsedData.find(d => d.id === id); if (item) { item.date = newDate; renderTable(); autoSave(); } }
        function updateCurrentPrice(id, newPrice) { const item = parsedData.find(d => d.id === id); if (item && newPrice) { item.currentPrice = parseFloat(newPrice); renderTable(); autoSave(); } }
        function removeRow(id) { parsedData = parsedData.filter(d => d.id !== id); renderTable(); showStatus('Removed', 'info'); autoSave(); }
        function clearAll() { if (parsedData.length === 0) { showStatus('Nothing to clear', 'error'); return; } if (confirm('Clear all data?')) { parsedData = []; renderTable(); showStatus('Cleared', 'info'); autoSave(); } }
        function refreshPrices() { if (parsedData.length === 0) { showStatus('No data', 'error'); return; } showStatus('Refreshing...', 'info'); parsedData.forEach(item => item.currentPrice = null); renderTable(); fetchCurrentPrices(parsedData); }
        function exportToCSV() { if (parsedData.length === 0) { showStatus('No data', 'error'); return; } const headers = ['#', 'Date', 'Ticker', 'Company', 'Price', 'Current', '% Change']; const rows = parsedData.map((item, i) => { const change = calculateChange(item.price, item.currentPrice); return [i + 1, item.date, item.ticker, `"${item.companyName}"`, item.price, item.currentPrice || '', change ? change.toFixed(2) + '%' : ''].join(','); }); downloadCSV([headers.join(','), ...rows].join('\n'), 'stock_comparison'); }
        function downloadCSV(csv, name) { const blob = new Blob([csv], { type: 'text/csv' }); const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = `${name}_${new Date().toISOString().split('T')[0]}.csv`; link.click(); showStatus('Exported', 'success'); }

        async function loadInsiderData() {
            try { showInsiderStatus('Loading...', 'info');
                const res = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${GOOGLE_SHEETS_ID}/values/InsiderTrades?key=${GOOGLE_API_KEY}`);
                if (res.ok) { const data = await res.json(); const rows = data.values || []; const dataRows = rows.length > 0 && rows[0][0] === 'id' ? rows.slice(1) : rows;
                    if (dataRows.length > 0) { insiderData = dataRows.map(row => ({ id: parseInt(row[0]) || 0, date: row[1] || '', ticker: row[2] || '', companyName: row[3] || '', news: row[4] || '', insider: row[5] || '', amount: row[6] || '', alertPrice: row[7] ? parseFloat(row[7]) : null, currentPrice: row[8] ? parseFloat(row[8]) : null, expanded: false, companyInfo: null })); renderInsiderTable(); showInsiderStatus(`Loaded ${insiderData.length} trades`, 'success'); fetchInsiderPrices(); }
                    else { renderInsiderTable(); showInsiderStatus('No trades yet', 'info'); } }
            } catch (e) { showInsiderStatus('Connection error', 'error'); }
        }

        async function fetchInsiderPrices() { for (const item of insiderData) { if (item.currentPrice === null || isNaN(item.currentPrice)) { try { const res = await fetch(`${ALPACA_DATA_URL}/stocks/${item.ticker}/trades/latest`, { headers: { 'APCA-API-KEY-ID': ALPACA_API_KEY, 'APCA-API-SECRET-KEY': ALPACA_SECRET_KEY } }); if (res.ok) { const data = await res.json(); if (data.trade?.p) item.currentPrice = data.trade.p; } } catch (e) {} renderInsiderTable(); await new Promise(r => setTimeout(r, 150)); } } }
        function refreshInsiderPrices() { if (insiderData.length === 0) { showInsiderStatus('No data', 'error'); return; } showInsiderStatus('Refreshing...', 'info'); insiderData.forEach(item => item.currentPrice = null); renderInsiderTable(); fetchInsiderPrices(); }

        async function triggerInsiderGmailScan() {
            showInsiderStatus('Scanning Gmail for new insider alerts‚Ä¶', 'info');
            try { await fetch(APPS_SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'fetchInsiderFromGmail' }) });
                setTimeout(async () => { await loadInsiderData(); showInsiderStatus('Gmail scan complete. Insider trades refreshed.', 'success'); }, 3000);
            } catch (e) { showInsiderStatus('Error triggering Gmail scan', 'error'); }
        }

        async function toggleInsiderCompanyInfo(id) { const item = insiderData.find(d => d.id === id); if (!item) return; item.expanded = !item.expanded; renderInsiderTable(); if (item.expanded && !item.companyInfo) await fetchInsiderCompanyInfo(item); }

        async function fetchInsiderCompanyInfo(item) {
            let info = {};
            try { const res = await fetch(`${ALPACA_TRADING_URL}/assets/${item.ticker}`, { headers: { 'APCA-API-KEY-ID': ALPACA_API_KEY, 'APCA-API-SECRET-KEY': ALPACA_SECRET_KEY } }); if (res.ok) { const asset = await res.json(); info = { exchange: asset.exchange, tradable: asset.tradable, shortable: asset.shortable }; } } catch (e) {}
            try { const res = await fetch(`https://finnhub.io/api/v1/stock/profile2?symbol=${item.ticker}&token=${FINNHUB_API_KEY}`); if (res.ok) { const profile = await res.json(); if (profile.finnhubIndustry) { info.industry = profile.finnhubIndustry; info.weburl = profile.weburl; info.description = `${profile.name || item.companyName} operates in ${profile.finnhubIndustry}.`; } } } catch (e) {}
            try { const grok = await getOrFetchGrokAnalysis(item.ticker); if (grok) { info.grokSector = grok.grokSector; info.grokWhatItDoes = grok.grokWhatItDoes; info.grokBottomLine = grok.grokBottomLine; info.grokBuyTheDip = grok.grokBuyTheDip; } } catch (e) {}
            item.companyInfo = Object.keys(info).length ? info : { error: true }; renderInsiderTable();
        }

        function renderInsiderCompanyInfo(item) {
            const info = item.companyInfo;
            if (!info || info.error) return '<p style="color: var(--accent-red);">Unable to load info</p>';
            const snapshotText = info.grokWhatItDoes || info.description || 'No description available.';
            const bottomlineText = info.grokBottomLine || 'No AI bottom line available yet.';
            const verdictRaw = info.grokBuyTheDip || '';
            let verdict = '', percent = '';
            if (verdictRaw) { const match = verdictRaw.match(/(Yes|No|Maybe|Wait)[^\d]*([\d]{1,3})%/i); if (match) { verdict = match[1].toUpperCase(); percent = match[2] + '%'; } }
            let verdictClass = ''; if (verdict === 'YES') verdictClass = 'verdict-yes'; else if (verdict === 'NO') verdictClass = 'verdict-no'; else if (verdict) verdictClass = 'verdict-maybe';
            const scoreboardHtml = verdict ? `<div class="buy-score ${verdictClass}"><div class="buy-score-label">Buy the dip</div><div class="buy-score-verdict">${verdict}</div><div class="buy-score-percent">${percent}</div></div>` : '';
            return `<div class="company-info-section snapshot-section"><h4>üìã Snapshot</h4><p>${snapshotText}</p>${info.grokSector ? `<p style="margin-top:8px;color:var(--text-tertiary);font-size:0.8rem;">Sector: ${info.grokSector}</p>` : ''}${info.weburl ? `<p style="margin-top:10px;"><a href="${info.weburl}" target="_blank">üåê Website</a></p>` : ''}</div><div class="company-info-section bottomline-section"><h4>üìä Bottom Line</h4><div class="bottomline-header">${scoreboardHtml}<div class="bottomline-text">${bottomlineText}</div></div><div class="info-grid fundamentals-grid"><div class="info-item"><label>Exchange</label><span>${info.exchange || 'N/A'}</span></div><div class="info-item"><label>Industry</label><span>${info.industry || 'N/A'}</span></div><div class="info-item"><label>Tradable</label><span style="color:${info.tradable ? 'var(--accent-green)' : 'var(--accent-red)'}">${info.tradable ? 'Yes' : 'No'}</span></div><div class="info-item"><label>Shortable</label><span style="color:${info.shortable ? 'var(--accent-green)' : 'var(--accent-red)'}">${info.shortable ? 'Yes' : 'No'}</span></div></div></div>`;
        }

        function renderInsiderTable() {
            const tbody = document.getElementById('insiderResultsBody'); const emptyState = document.getElementById('insiderEmptyState'); document.getElementById('insiderRowCount').textContent = `${insiderData.length} rows`;
            if (insiderData.length === 0) { tbody.innerHTML = ''; emptyState.style.display = 'block'; return; } emptyState.style.display = 'none';
            tbody.innerHTML = insiderData.map((item, index) => {
                const change = item.alertPrice && item.currentPrice ? ((item.currentPrice - item.alertPrice) / item.alertPrice) * 100 : null; const changeClass = change !== null ? (change >= 0 ? 'change-positive' : 'change-negative') : ''; const changeText = change !== null ? `${change >= 0 ? '+' : ''}${change.toFixed(2)}%` : '‚Äî';
                let currentPriceClass = ''; if (item.currentPrice && item.alertPrice) { currentPriceClass = item.currentPrice >= item.alertPrice ? 'price-positive' : 'price-negative'; }
                const rowColor = getDateColor(item.date); const isExpanded = item.expanded || false;
                let html = `<tr style="background-color: ${rowColor};"><td>${index + 1}</td><td>${item.date}</td><td class="ticker-cell ${isExpanded ? 'expanded' : ''}" onclick="toggleInsiderCompanyInfo(${item.id})">${item.ticker}</td><td>${item.companyName}</td><td class="news-cell">${item.news}</td><td>${item.insider ? `<span class="insider-badge">${item.insider}</span>` : '‚Äî'}</td><td class="amount-cell">${item.amount || '‚Äî'}</td><td class="price-cell">${item.alertPrice ? '$' + item.alertPrice.toFixed(2) : '‚Äî'}</td><td class="price-cell ${currentPriceClass}">${item.currentPrice ? '$' + item.currentPrice.toFixed(2) : '<span class="loading"></span>'}</td><td class="${changeClass}">${changeText}</td></tr>`;
                if (isExpanded) { html += `<tr class="company-info-row" style="background-color: ${rowColor};"><td colspan="10"><div class="company-info-content">${item.companyInfo ? renderInsiderCompanyInfo(item) : '<div class="company-info-loading"><span class="loading"></span> Loading AI analysis...</div>'}</div></td></tr>`; }
                return html;
            }).join('');
        }

        function exportInsiderCSV() { if (insiderData.length === 0) { showInsiderStatus('No data', 'error'); return; } const headers = ['#', 'Date', 'Ticker', 'Company', 'News', 'Insider', 'Amount', 'Alert Price', 'Current', '% Change']; const rows = insiderData.map((item, i) => { const change = item.alertPrice && item.currentPrice ? ((item.currentPrice - item.alertPrice) / item.alertPrice) * 100 : null; return [i + 1, item.date, item.ticker, `"${item.companyName}"`, `"${item.news}"`, item.insider, item.amount, item.alertPrice || '', item.currentPrice || '', change ? change.toFixed(2) + '%' : ''].join(','); }); downloadCSV([headers.join(','), ...rows].join('\n'), 'insider_trades'); }
    </script>
</body>
</html>
